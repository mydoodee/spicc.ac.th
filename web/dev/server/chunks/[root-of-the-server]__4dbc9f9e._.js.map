{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo11/Desktop/xx/spicc.ac.th-main/lib/db.js"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n// Ensure mysql2 is used as a server-only package\r\n\r\nlet pool = global.dbPool || null;\r\n\r\nfunction getPool() {\r\n    if (!pool) {\r\n        pool = mysql.createPool({\r\n            host: process.env.DB_HOST,\r\n            user: process.env.DB_USER,\r\n            password: process.env.DB_PASSWORD,\r\n            database: process.env.DB_NAME,\r\n            port: parseInt(process.env.DB_PORT || '3306'),\r\n            waitForConnections: true,\r\n            connectionLimit: 10,\r\n            queueLimit: 0,\r\n            connectTimeout: 30000,\r\n            enableKeepAlive: true,\r\n            keepAliveInitialDelay: 0,\r\n            charset: 'utf8mb4',\r\n        });\r\n        global.dbPool = pool;\r\n    }\r\n    return pool;\r\n}\r\n\r\nexport async function query(sql, params = []) {\r\n    const pool = getPool();\r\n    const [rows] = await pool.execute(sql, params);\r\n    return rows;\r\n}\r\n\r\nexport default getPool;\r\n"],"names":[],"mappings":";;;;;;AAAA;;AACA,iDAAiD;AAEjD,IAAI,OAAO,yDAAO,MAAM,IAAI;AAE5B,SAAS;IACL,IAAI,CAAC,MAAM;QACP,OAAO,mLAAK,CAAC,UAAU,CAAC;YACpB,MAAM,QAAQ,GAAG,CAAC,OAAO;YACzB,MAAM,QAAQ,GAAG,CAAC,OAAO;YACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;YACjC,UAAU,QAAQ,GAAG,CAAC,OAAO;YAC7B,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;YACtC,oBAAoB;YACpB,iBAAiB;YACjB,YAAY;YACZ,gBAAgB;YAChB,iBAAiB;YACjB,uBAAuB;YACvB,SAAS;QACb;QACA,yDAAO,MAAM,GAAG;IACpB;IACA,OAAO;AACX;AAEO,eAAe,MAAM,GAAG,EAAE,SAAS,EAAE;IACxC,MAAM,OAAO;IACb,MAAM,CAAC,KAAK,GAAG,MAAM,KAAK,OAAO,CAAC,KAAK;IACvC,OAAO;AACX;uCAEe"}},
    {"offset": {"line": 110, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo11/Desktop/xx/spicc.ac.th-main/lib/auth.js"],"sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport bcrypt from 'bcryptjs';\r\nimport { cookies } from 'next/headers';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'fallback-secret-key';\r\nconst TOKEN_NAME = 'admin_token';\r\nconst TOKEN_EXPIRY = '24h';\r\n\r\nexport async function hashPassword(password) {\r\n    return bcrypt.hash(password, 12);\r\n}\r\n\r\nexport async function verifyPassword(password, hashedPassword) {\r\n    return bcrypt.compare(password, hashedPassword);\r\n}\r\n\r\nexport function generateToken(payload) {\r\n    return jwt.sign(payload, JWT_SECRET, { expiresIn: TOKEN_EXPIRY });\r\n}\r\n\r\nexport function verifyToken(token) {\r\n    try {\r\n        return jwt.verify(token, JWT_SECRET);\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function setAuthCookie(token) {\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(TOKEN_NAME, token, {\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'lax',\r\n        maxAge: 60 * 60 * 24, // 24 hours\r\n        path: '/',\r\n    });\r\n}\r\n\r\nexport async function removeAuthCookie() {\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(TOKEN_NAME, '', {\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'lax',\r\n        maxAge: 0,\r\n        path: '/',\r\n    });\r\n}\r\n\r\nexport async function getAuthUser() {\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get(TOKEN_NAME)?.value;\r\n    if (!token) return null;\r\n    return verifyToken(token);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AACA;AACA;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,aAAa;AACnB,MAAM,eAAe;AAEd,eAAe,aAAa,QAAQ;IACvC,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AACjC;AAEO,eAAe,eAAe,QAAQ,EAAE,cAAc;IACzD,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AACpC;AAEO,SAAS,cAAc,OAAO;IACjC,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW;IAAa;AACnE;AAEO,SAAS,YAAY,KAAK;IAC7B,IAAI;QACA,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC7B,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAEO,eAAe,cAAc,KAAK;IACrC,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,YAAY,GAAG,CAAC,YAAY,OAAO;QAC/B,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK;QAClB,MAAM;IACV;AACJ;AAEO,eAAe;IAClB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,YAAY,GAAG,CAAC,YAAY,IAAI;QAC5B,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ;QACR,MAAM;IACV;AACJ;AAEO,eAAe;IAClB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,aAAa;IAC3C,IAAI,CAAC,OAAO,OAAO;IACnB,OAAO,YAAY;AACvB"}},
    {"offset": {"line": 183, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo11/Desktop/xx/spicc.ac.th-main/app/api/menus/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { query } from '@/lib/db';\r\nimport { getAuthUser } from '@/lib/auth';\r\n\r\n// GET — ดึงเมนูทั้งหมด (จัดเป็น tree)\r\nexport async function GET() {\r\n    try {\r\n        const menus = await query(\r\n            'SELECT m.*, p.title as page_title, p.slug as page_slug, c.title as course_title, c.slug as course_slug, n.title as news_title, n.slug as news_slug FROM cms_menus m LEFT JOIN cms_pages p ON m.page_id = p.id LEFT JOIN cms_courses c ON m.course_id = c.id LEFT JOIN cms_news n ON m.news_id = n.id ORDER BY m.sort_order ASC, m.id ASC'\r\n        );\r\n\r\n        // Build tree structure\r\n        const menuMap = {};\r\n        const tree = [];\r\n\r\n        menus.forEach(m => {\r\n            menuMap[m.id] = { ...m, children: [] };\r\n        });\r\n\r\n        menus.forEach(m => {\r\n            if (m.parent_id && menuMap[m.parent_id]) {\r\n                menuMap[m.parent_id].children.push(menuMap[m.id]);\r\n            } else {\r\n                tree.push(menuMap[m.id]);\r\n            }\r\n        });\r\n\r\n        return NextResponse.json({ success: true, menus: tree, allMenus: menus });\r\n    } catch (error) {\r\n        console.error('Get menus error:', error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n\r\n// POST — สร้างเมนูใหม่\r\nexport async function POST(request) {\r\n    try {\r\n        const user = await getAuthUser();\r\n        if (!user) {\r\n            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n        }\r\n\r\n        const { title, url, page_id, course_id, news_id, parent_id, sort_order, is_active } = await request.json();\r\n\r\n        if (!title) {\r\n            return NextResponse.json({ error: 'กรุณากรอกชื่อเมนู' }, { status: 400 });\r\n        }\r\n\r\n        const result = await query(\r\n            'INSERT INTO cms_menus (title, url, page_id, course_id, news_id, parent_id, sort_order, is_active) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',\r\n            [title, url || null, page_id || null, course_id || null, news_id || null, parent_id || null, sort_order || 0, is_active !== undefined ? is_active : 1]\r\n        );\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            menu: { id: result.insertId, title, url, page_id, course_id, news_id, parent_id, sort_order, is_active: is_active !== undefined ? is_active : 1 },\r\n        });\r\n    } catch (error) {\r\n        console.error('Create menu error:', error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n\r\n// PATCH — อัปเดตลำดับเมนูแบบกลุ่ม (Bulk sort order update)\r\nexport async function PATCH(request) {\r\n    try {\r\n        const user = await getAuthUser();\r\n        if (!user) {\r\n            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n        }\r\n\r\n        const { updates } = await request.json(); // updates: [{id, sort_order}, ...]\r\n\r\n        if (!updates || !Array.isArray(updates)) {\r\n            return NextResponse.json({ error: 'Invalid data' }, { status: 400 });\r\n        }\r\n\r\n        // Perform bulk updates in a transaction or individual queries\r\n        for (const item of updates) {\r\n            await query(\r\n                'UPDATE cms_menus SET sort_order = ? WHERE id = ?',\r\n                [item.sort_order, item.id]\r\n            );\r\n        }\r\n\r\n        return NextResponse.json({ success: true, message: 'Updated successfully' });\r\n    } catch (error) {\r\n        console.error('Update menu orders error:', error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}